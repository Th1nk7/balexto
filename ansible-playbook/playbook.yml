---
- name: Setup Docker, WireGuard VPN, and Cloudflare Dynamic DNS
  hosts: localhost
  become: true

  vars:
    cloudflare_email: "{{ lookup('env', 'CF_EMAIL') }}"
    cloudflare_api_token: "{{ lookup('env', 'CF_API_TOKEN') }}"
    cloudflare_zone: "balexto.dk"
    cloudflare_record: "vpn.balexto.dk"
    wireguard_port: 51820
    wireguard_config_dir: "/etc/wireguard"

  tasks:
    # Install prerequisites for Docker and WireGuard tools
    - name: Install prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - wireguard-tools  # Install WireGuard tools
        state: present
        update_cache: yes

    # Clean up old Docker key files
    - name: Remove old Docker key files
      file:
        path: /etc/apt/keyrings/docker.asc
        state: absent

    # Add Docker's official GPG key
    - name: Download Docker's GPG key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.gpg
        mode: '0644'

    # Set up the Docker repository
    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    # Install Docker CE
    - name: Install Docker CE
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes

    # Install Docker Compose
    - name: Install Docker Compose
      apt:
        name: docker-compose-plugin
        state: present

    # Generate WireGuard keys
    - name: Generate WireGuard private key
      command: wg genkey
      register: wireguard_private_key

    - name: Generate WireGuard public key
      shell: echo "{{ wireguard_private_key.stdout }}" | wg pubkey
      register: wireguard_public_key

    # Generate WireGuard configuration
    - name: Create WireGuard configuration directory
      file:
        path: "{{ wireguard_config_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Generate WireGuard configuration file
      copy:
        dest: "{{ wireguard_config_dir }}/wg0.conf"
        content: |
          [Interface]
          Address = 10.0.0.1/24
          ListenPort = {{ wireguard_port }}
          PrivateKey = {{ wireguard_private_key.stdout }}

          [Peer]
          PublicKey = {{ wireguard_public_key.stdout }}
          AllowedIPs = 10.0.0.2/32
          Endpoint = {{ cloudflare_record }}:{{ wireguard_port }}
        owner: root
        group: admin
        mode: '0640'

    # Set up WireGuard VPN
    - name: Create WireGuard container
      docker_container:
        name: wireguard
        image: linuxserver/wireguard
        state: started
        restart_policy: always
        ports:
          - "{{ wireguard_port }}:51820/udp"
        env:
          PUID: "1000"
          PGID: "1000"
          TZ: "Etc/UTC"
          SERVERURL: "{{ cloudflare_record }}"
          SERVERPORT: "{{ wireguard_port | string }}"  # Convert to string
          PEERS: "1"
          PEERDNS: "1.1.1.1"
          ALLOWEDIPS: "0.0.0.0/0"
        volumes:
          - "{{ wireguard_config_dir }}:/config"

    # Get public IP address
    - name: Get public IP address
      uri:
        url: https://api.ipify.org
        return_content: yes
      register: public_ip_response

    # Set up Cloudflare Dynamic DNS
    - name: Update Cloudflare DNS record
      community.general.cloudflare_dns:
        zone: "{{ cloudflare_zone }}"
        record: "{{ cloudflare_record }}"
        type: A
        value: "{{ public_ip_response.content }}"  # Use public IP
        ttl: 120
        proxied: yes
        api_token: "{{ cloudflare_api_token }}"
      tags:
        - update_dns